rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - users can only read their own document
    match /users/{userId} {
      // Allow read if the user is authenticated and accessing their own document
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Only allow writes from authenticated users to their own document
      // But restrict which fields can be updated (prevent users from modifying subscription/usage data)
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                      'stripeCustomerId', 
                      'subscriptionId', 
                      'planTier', 
                      'usage',  // Prevent direct usage manipulation
                      'subscriptionStatus',
                      'cycleStart',
                      'lastResetAt'
                    ]);
      
      // Prevent users from creating their own documents
      // (These should be created by Stripe webhook or Admin SDK)
      allow create: if false;
      
      // Prevent users from deleting their documents
      allow delete: if false;
    }
    
    // Scans collection - users can read their own scans
    match /scans/{scanId} {
      // Allow read if the user is authenticated and the scan belongs to them
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Users cannot directly create, update, or delete scans
      // (These should be managed by API routes)
      allow write: if false;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
